/*
 * OLED_ELV.c
 *
 *  Created on: May 10, 2022
 *      Author: js372
 */
#include "OLED_ELV.h"

unsigned char arrow [4][40]=
{
		{
				0x00,0x00,0xff,0x00,0x00,0x00,0x00,0x00,

				0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,

				0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,

				0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,

				0x00,0x00,0xff,0x00,0x00,0x00,0x00,0x00
		},
		{
				0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

				0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff,

				0xff,0xff,0xff,0xff,0xff,0x00,0xff,0xff,

				0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		},
		{
				0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x00,

				0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x00,

				0xff,0xff,0xff,0x00,0xff,0xff,0xff,0xff,

				0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x00,

				0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x00
		},
		{
				0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x00,

				0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,

				0xff,0x00,0xff,0xff,0xff,0xff,0xff,0xff,

				0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,

				0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x00
		}
};

unsigned char downArrow [4][40]=
{
		{
				0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00,

				0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x00,

				0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,

				0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x00,

				0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00
		},
		{
				0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff,

				0xff,0xff,0x00,0xff,0xff,0xff,0xff,0xff,

				0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff,

				0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff
		},
		{
				0x00,0xff,0x00,0x00,0x00,0x00,0x00,0x00,

				0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,

				0xff,0xff,0xff,0xff,0x00,0xff,0xff,0xff,

				0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,

				0x00,0xff,0x00,0x00,0x00,0x00,0x00,0x00
		},
		{
				0x00,0x00,0x00,0xff,0x00,0x00,0x00,0x00,

				0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,

				0xff,0xff,0xff,0xff,0xff,0xff,0x00,0xff,

				0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,

				0x00,0x00,0x00,0xff,0x00,0x00,0x00,0x00
		}
};
unsigned char small [6][40] =
{
		{
				0x00,0x00,0xff,0x00,0x00,0x00,0x00,0xff,

				0x00,0xff,0x00,0x00,0x00,0x00,0x00,0xff,

				0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,

				0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,

				0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff
		},
		{
				0x00,0xff,0x00,0x00,0x00,0x00,0xff,0xff,

				0xff,0x00,0x00,0x00,0x00,0xff,0x00,0xff,

				0xff,0x00,0x00,0x00,0xff,0x00,0x00,0xff,

				0xff,0x00,0x00,0xff,0x00,0x00,0x00,0xff,

				0x00,0xff,0xff,0x00,0x00,0x00,0x00,0xff,
		},
		{
				0x00,0xff,0x00,0x00,0x00,0x00,0xff,0x00,

				0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0xff,0x00,0x00,0x00,0xff,

				0x00,0xff,0xff,0x00,0xff,0xff,0xff,0x00,
		},
		{
				0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00,

				0x00,0x00,0xff,0xff,0x00,0xff,0x00,0x00,

				0x00,0xff,0x00,0x00,0x00,0xff,0x00,0x00,

				0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,

				0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00,
		},
		{
				0xff,0xff,0xff,0xff,0x00,0x00,0xff,0x00,

				0xff,0x00,0x00,0xff,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0xff,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0xff,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0x00,0xff,0xff,0xff,0x00,
		},
		{
				0x00,0xff,0xff,0xff,0xff,0xff,0xff,0x00,

				0xff,0x00,0x00,0xff,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0xff,0x00,0x00,0x00,0xff,

				0xff,0x00,0x00,0xff,0x00,0x00,0x00,0xff,

				0x00,0xff,0x00,0x00,0xff,0xff,0xff,0x00,
		}
};
extern I2C_HandleTypeDef hi2c1;

uint8_t SSD1306_Init(void) {
	if (HAL_I2C_IsDeviceReady(&hi2c1, SSD1306_I2C_ADDR, 1, 20000) != HAL_OK) {
		/* Return false */
		return 0;
	}

	/* A little delay */
	uint32_t p = 2500;
	while(p>0)
		p--;

	/* Init LCD */
	OLED_WRITECOMMAND(0xAE); //display off
	OLED_WRITECOMMAND(0x20); //Set Memory Addressing Mode
	OLED_WRITECOMMAND(0x01); //00,Horizontal Addressing Mode;01,Vertical Addressing Mode;10,Page Addressing Mode (RESET);11,Invalid
	OLED_WRITECOMMAND(0xB0); //Set Page Start Address for Page Addressing Mode,0-7
	OLED_WRITECOMMAND(0xC8); //Set COM Output Scan Direction
	OLED_WRITECOMMAND(0x00); //---set low column address
	OLED_WRITECOMMAND(0x10); //---set high column address
	OLED_WRITECOMMAND(0x40); //--set start line address
	OLED_WRITECOMMAND(0x81); //--set contrast control register
	OLED_WRITECOMMAND(0x7F);
	OLED_WRITECOMMAND(0xA1); //--set segment re-map 0 to 127
	OLED_WRITECOMMAND(0xA6); //--set normal display
	OLED_WRITECOMMAND(0xA8); //--set multiplex ratio(1 to 64)
	OLED_WRITECOMMAND(0x3F); //
	OLED_WRITECOMMAND(0xA4); //0xa4,Output follows RAM content;0xa5,Output ignores RAM content
	OLED_WRITECOMMAND(0xD3); //-set display offset
	OLED_WRITECOMMAND(0x00); //-not offset
	OLED_WRITECOMMAND(0xD5); //--set display clock divide ratio/oscillator frequency
	OLED_WRITECOMMAND(0xF0); //--set divide ratio
	OLED_WRITECOMMAND(0xD9); //--set pre-charge period
	OLED_WRITECOMMAND(0x22); //
	OLED_WRITECOMMAND(0xDA); //--set com pins hardware configuration
	OLED_WRITECOMMAND(0x12);
	OLED_WRITECOMMAND(0xDB); //--set vcomh
	OLED_WRITECOMMAND(0x20); //0x20,0.77xVcc
	OLED_WRITECOMMAND(0x8D); //--set DC-DC enable
	OLED_WRITECOMMAND(0x14); //
	OLED_WRITECOMMAND(0xAF); //--turn on SSD1306 panel
	/* Return OK */
	return 1;
}

void OLED_I2C_Write(uint8_t address, uint8_t reg, uint8_t data) {
	uint8_t dt[2];
	dt[0] = reg;
	dt[1] = data;
	HAL_I2C_Master_Transmit(&hi2c1, address, dt, 2, 10);
}
void OLED_sel(uint8_t sel){
	HAL_GPIO_WritePin(OLED_ADDR0_GPIO_Port, OLED_ADDR0_Pin, sel&0x01);
	HAL_GPIO_WritePin(OLED_ADDR1_GPIO_Port, OLED_ADDR1_Pin, sel&0x02);
}
void OLED_clear(){
	uint8_t x, y;

	OLED_WRITECOMMAND(0x21);
	OLED_WRITECOMMAND(0);
	OLED_WRITECOMMAND(127);
	for(y=0; y<128; y++){
		for(x=0; x<=7; x++){
			OLED_WRITEDATA(0);
		}
	}
}
void OLED_fill(){
	uint8_t x, y;

	OLED_WRITECOMMAND(0x21);
	OLED_WRITECOMMAND(0);
	OLED_WRITECOMMAND(127);
	for(y=0; y<128; y++){
		for(x=0; x<=7; x++){
			OLED_WRITEDATA(0xff);
		}
	}
}
void OLED_init(){
	for(int i=0; i<3; i++){
		OLED_sel(i);
		SSD1306_Init();
		OLED_clear();
	}
}
void OLED_number(uint8_t x, uint8_t num){
	uint8_t y=0;
	uint8_t i=0;
	OLED_WRITECOMMAND(0x21);
	OLED_WRITECOMMAND(x);
	OLED_WRITECOMMAND(x+19);
	for(y=0; y<=4; y++){
		for(x=0; x<32; x++){
			OLED_WRITEDATA(small[num-1][8*y+i]);
			i++;
			i%=8;
		}
	}
}
void OLED_up(uint8_t x, uint8_t step){
	uint8_t y;
	int i=0;

	OLED_WRITECOMMAND(0x21);
	OLED_WRITECOMMAND(x);
	OLED_WRITECOMMAND(x+19);
	for(y=0; y<=4; y++){
		for(x=0; x<32; x++){
			OLED_WRITEDATA(arrow[step][8*y+i]);
			i++;
			i%=8;
		}
	}
}
void OLED_down(uint8_t x, uint8_t step){
	uint8_t y;
	int i=0;

	OLED_WRITECOMMAND(0x21);
	OLED_WRITECOMMAND(x);
	OLED_WRITECOMMAND(x+19);
	for(y=0; y<=4; y++){
		for(x=0; x<32; x++){
			OLED_WRITEDATA(downArrow[step][8*y+i]);
			i++;
			i%=8;
		}
	}
	i=0;
}
void OLED_open(uint8_t step){
	OLED_fill();
	OLED_WRITECOMMAND(0x21);
	OLED_WRITECOMMAND(64-16*step);
	OLED_WRITECOMMAND(63+16*step);
	for(int y=0; y<8; y++){
		for(int x=0; x<32*step; x++){
			OLED_WRITEDATA(0);
		}
	}
}
void OLED_close(uint8_t step){
	OLED_clear();
	OLED_WRITECOMMAND(0x21);
	OLED_WRITECOMMAND(0);
	OLED_WRITECOMMAND(16*step);
	for(int y=0; y<8; y++){
		for(int x=0; x<16*step; x++){
			OLED_WRITEDATA(0xff);
		}
	}
	OLED_WRITECOMMAND(0x21);
	OLED_WRITECOMMAND(127-16*step);
	OLED_WRITECOMMAND(127);
	for(int y=0; y<8; y++){
		for(int x=0; x<16*step; x++){
			OLED_WRITEDATA(0xff);
		}
	}
}
